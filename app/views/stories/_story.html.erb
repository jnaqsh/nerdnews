<!-- cache status of Story -->
<% status = hide?(story) %>

<article <%= "class=grey-out" if status and current_page?(action: 'index') %> >
  <div class='row'>
    <div class='span1'>
      <div class='story-image'>
      <% unless story.tags.blank? %>
        <%= link_to image_tag(story.tags.first.thumbnail.url(:thumb), class: 'img-polaroid'), stories_url(tag: story.tags.first.name) %>
      <% end %>
      </div>
      <ul class="tags">
        <% story.tags.each do |tag| %>
        <% favored = true if current_user and current_user.included_tag_as_favorite?(tag.name) %>
          <li>
            <p>
            <a href="<%= stories_url(tag: tag) %>"><%= tag.name %></a>
            <span class="tag_id_<%= tag.id %> <%= 'yellow' if favored %>">
              <% if current_user %>
                <%= link_to add_to_favorites_user_path(id: current_user, tag: tag.name), class: "#{'yellow' if favored}", method: :post, remote: true do %>
                  <i class='icon-star'>1</i>
                <% end %>
              <% end %>
            </span>
            </p>
          </li>
        <% end %>
      </ul>
    </div>

    <div class='span11'>

      <h3><%= link_to story.title, story %></h3>

      <% unless params[:preview_button] %>
        <ul class='social-icons'>
          <li>
            <a href="http://www.facebook.com/sharer.php?u=<%= story_url(story) %>&t=<%= story.title %>" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="icon-facebook-sign"></i></a>
          </li>
          <li>
            <a href="http://twitter.com/home?status=<%= story.title + " " + story_url(story) %>" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="icon-twitter-sign"></i></a>
          </li>
          <li>
            <a href="https://m.google.com/app/plus/x/?v=compose&content=<%= story.title %>&url=<%= story_url(story) %>" onclick="javascript:window.open(this.href,'', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="icon-google-plus-sign"></i></a>
          </li>
        </ul>
      <% end %>

      <h5 class="muted">

        <small>
          <span>
            <i class='icon-plus'></i>
            <%= t('stories.index.point') + story.total_point.to_farsi if story.approved? %>
          </span>
          
          <span>
            <i class='icon-user'></i>
            <%= user_name(story) %>
          </span>
          
          <span>
            <i class='icon-calendar'></i>
            <%= to_jalali(story.publish_date) if story.approved? %>
          </span>

          <% if story.id %>
            <span>
              <i class='icon-comments-alt'></i>
              <%= link_to story_path(story) do %>
                <%=t 'stories.show.comments' %>
                <%= story.comments_count.to_farsi %>
              <% end %>
            </span>
          <% end %>
        </small>
      </h5>

      <% if !status or !current_page?(controller: 'stories', action: 'index') %>
        <p><%= user_name(story) %> می‌نویسد:</p>
        <blockquote>
          <%= sanitize(RedCloth.new(story.content, [:filter_html, :filter_styles]).to_html) %><br />
          <%= source_of_story(story) %>
        </blockquote>
      <% end %>

      <%= render partial: "stories/story_operation", locals: {story: story} %>
    </div>
  </div>
</article>
<hr />
