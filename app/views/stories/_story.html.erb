<!-- cache status of Story -->
<% status = hide_story?(story) %>

<article <%= "class=grey-out" if status %> >
  <div class='row'>
    <div class='span1'>
      <div class='story-image'>
      <% unless story.tags.blank? %>
        <%= link_to image_tag(story.tags.first.thumbnail.url(:thumb), class: 'img-polaroid'), stories_url(tag: story.tags.first.name) %>
      <% end %>
      </div>
      <% unless status %>
        <ul class="tags">
          <% story.tags.each do |tag| %>
          <% favored = true if current_user and current_user.included_tag_as_favorite?(tag.name) %>
            <%= content_tag :li, rel: "tooltip", title: tag.name do %>
              <p>
                <%= link_to stories_url(tag: tag.name) do %>
                  <%= truncate(tag.name, length: 10) %>
                <% end %>
                <span class="tag_id_<%= tag.id %> <%= 'yellow' if favored %>">
                  <% if current_user && !favored %>
                    <%= link_to add_to_favorites_user_path(id: current_user, tag: tag.name), class: "#{'yellow' if favored}", method: :post, remote: true do %>
                      <i class='icon-star'>1</i>
                    <% end %>
                  <% end %>
                </span>
              </p>
            <% end %>
          <% end %>
        </ul>
      <% end %>
    </div>

    <div class='span11'>

      <h3><%= link_to story.title, story %></h3>

      <% unless status or params[:preview_button] %>
        <%= render partial: 'stories/social_share', locals: {title: story.title, share_url: story_url(story)} %>
      <% end %>

      <h5 class="muted">

        <small>
          <span>
            <i class='icon-plus'></i>
            <%= t('stories.index.point') + story.total_point.to_farsi if story.approved? %>
          </span>

          <span>
            <i class='icon-user'></i>
            <%= user_name(story) %>
          </span>

          <span>
            <i class='icon-calendar'></i>
            <%= to_jalali(story.publish_date) if story.approved? %>
          </span>

          <% if story.id %>
            <span>
              <i class='icon-comments-alt'></i>
              <%= link_to story_path(story) do %>
                <%=t 'stories.show.comments' %>
                <%= story.comments_count.to_farsi %>
              <% end %>
            </span>
          <% end %>
        </small>
      </h5>

      <% unless status %>
        <p><%= user_name(story) %> می‌نویسد:</p>
        <blockquote>
          <%= sanitize(RedCloth.new(story.content, [:filter_html, :filter_styles]).to_html) %><br />
          <%= source_of_story(story) %>
        </blockquote>
      <% end %>

      <%= render partial: "stories/story_operation", locals: {story: story} %>
    </div>
  </div>
</article>
<hr />
